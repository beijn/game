name: builder
on:
  push:
    branches: [ main ]
env: 
  target:  wasm32-unknown-unknown
  imgbase: ghcr.io/beijn/game-builder

jobs:
  build-game-container:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - run: |
        export BUILDER="${{env.imgbase}}:${{env.target}}"
        echo ${{secrets.GITHUB_TOKEN}} | docker login ghcr.io -u ${{github.actor}} --password-stdin
        export DOCKER_BUILDKIT=1 
        docker pull $BUILDER || :
        docker build . -t $BUILDER -f ./Dockerfile --cache-from $BUILDER --rm=false --build-arg TARGET=${{env.target}}
        docker push $BUILDER

